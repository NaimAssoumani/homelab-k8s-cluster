---


- name : Install packages
  apt:
    pkg:
      - apt-transport-https
      - curl
      - ca-certificates
      - gpg

- name: Add Kubernetes GPG key 
  ansible.builtin.get_url:
    url: https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key
    dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
    mode: '0644'
    force: true


- name: Add Kubernetes repository 
  ansible.builtin.apt_repository:
    repo: 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /'
    state: present
    update_cache: false

- name: Add Docker GPG key 
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /etc/apt/keyrings/docker-apt-keyring.asc
    mode: '0644'
    force: true

- name: Add Docker repository 
  ansible.builtin.apt_repository:
    repo: 'deb [signed-by=/etc/apt/keyrings/docker-apt-keyring.asc] https://download.docker.com/linux/debian bookworn stable'
    state: present
    update_cache: false

- name : Install packages for kube
  apt:
    pkg:
      - kubectl
      - kubeadm
      - kubelet
      - containerd


- name: Hold kube services 
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubectl
    - kubeadm
    - kubelet

- name: Create containerd folder
  ansible.builtin.file:
    name: /etc/containerd/
    owner: root
    group: root
    mode: 0644
    state: directory

- name: Delete Container default config
  ansible.builtin.copy:
    src: files/config.toml
    dest: /etc/containerd/config.toml
    owner: root
    group: root
    mode: 0644
  notify: Restart containerd

- name: Configure systctl
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/kubernetes.conf
  with_dict: '{{ sysctl_config }}'

- name: modification de l'etc/hosts pour le endpoint kube
  ansible.builtin.lineinfile:
    path: /etc/hosts
    insertafter: '127.0.0.1 localhost'
    line: "10.0.0.8 {{ endpoint_control_plane }}"